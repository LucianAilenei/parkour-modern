name: SonarCloud Analysis with Debugging

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Permite rularea manualƒÉ din GitHub Actions

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Necesar pentru SonarCloud

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Debug SonarCloud Configuration
        run: |
          echo "üõ†Ô∏è Debugging SonarCloud Configuration..."
          echo "SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}"
          echo "SONAR_ORG: ${{ secrets.SONAR_ORG }}"
          echo "SONAR_HOST_URL: https://sonarcloud.io"
          echo "Checking if secrets exist..."
          if [ -z "${{ secrets.SONAR_PROJECT_KEY }}" ]; then
            echo "‚ùå ERROR: SONAR_PROJECT_KEY is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SONAR_ORG }}" ]; then
            echo "‚ùå ERROR: SONAR_ORG is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "‚ùå ERROR: SONAR_TOKEN is not set!"
            exit 1
          fi
          echo "‚úÖ SonarCloud secrets exist."

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven
          restore-keys: ${{ runner.os }}-maven

      - name: Build, run tests, and generate JaCoCo coverage report
        run: |
          mvn clean test jacoco:report
          ls -l target/site/jacoco/  # Debugging - verificƒÉ dacƒÉ jacoco.xml existƒÉ

      - name: Run SonarCloud Analysis
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.organization=${{ secrets.SONAR_ORG }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

      - name: Ensure SonarCloud report is generated
        run: |
          echo "üõ†Ô∏è Checking for SonarCloud report..."
          for i in {1..12}; do
            if [ -f ".scannerwork/report-task.txt" ]; then
              echo "‚úÖ SonarCloud report found!"
              cat .scannerwork/report-task.txt  # Debug - afi»ôeazƒÉ raportul
              break
            fi
            echo "Waiting for SonarCloud report..."
            sleep 5
          done
          if [ ! -f ".scannerwork/report-task.txt" ]; then
            echo "‚ùå ERROR: SonarCloud report was not generated!"
            exit 1
          fi

      - name: SonarCloud Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Fail the build if Quality Gate fails
        run: |
          STATUS=$(curl -s "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ secrets.SONAR_PROJECT_KEY }}" | jq -r .projectStatus.status)
          if [[ "$STATUS" == "ERROR" ]]; then
            echo "‚ùå SonarCloud Quality Gate FAILED!"
            exit 1
          else
            echo "‚úÖ SonarCloud Quality Gate PASSED!"
          fi
